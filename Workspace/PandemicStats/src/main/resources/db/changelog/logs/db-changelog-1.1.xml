<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog
	xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd">
	<changeSet id="adiciona as functions, trigger, views e grupos"
		author="Eduardo Mateus da Costa">
		<sql stripComments="true" splitStatements="true" endDelimiter="@"> <!--@ finaliza pois nas functions tem ; no meio -->
		
			<!--Tipo de  resposta cidade-covid -->
			create type tp_cid_covid as 
			(
				nomusu varchar(100),
				sexusu char(1),
				nomemp varchar(100)
			);@
			
			<!--Funcao cidade-covid -->
			create or replace function cidade_covid(codigo numeric(6,0))
			returns setof tp_cid_covid
			as
			$body$
			begin
				return query select u.nomusu, u.sexusu, e.nomemp from usuario u 
						inner join empresa e on u.cnpjemp = e.cnpjemp
						inner join endereco en on en.cpfusu = u.cpfusu
						inner join cidade c on en.codcid = c.codcid
						inner join paciente p on p.cpfusu = u.cpfusu
						where (p.sitpac = 'ISOLAMENTO' or p.sitpac = 'INTERNADO') and (c.codcid = codigo);
			end
			$body$
			language plpgsql;@
			
			
			<!--Tipo de resposta empresa-covid -->
			create type tp_emp_covid as 
			(
				nomusu varchar(100),
				sexusu char(1),
				nomcid varchar(60)
			);@
			
			
			<!--Funcao empresa-covid -->
			create or replace function empresa_covid(cnpj numeric(14,0))
			returns setof tp_emp_covid
			as
			$body$
			begin
				return query select u.nomusu, u.sexusu, c.nomcid from usuario u 
						inner join empresa e on u.cnpjemp = e.cnpjemp
						inner join endereco en on en.cpfusu = u.cpfusu
						inner join cidade c on en.codcid = c.codcid
						inner join paciente p on p.cpfusu = u.cpfusu
						where (p.sitpac = 'ISOLAMENTO' or p.sitpac = 'INTERNADO') and (e.cnpjemp = cnpj);
			end
			$body$
			language plpgsql;@
			
			<!--Funcao primeria-dose-cidade -->
			create or replace function p_dose_cidade(codigo numeric(6,0))
			returns numeric
			as
			$body$
			declare
				conta NUMERIC := 0;
			begin
				select count(*) into conta from vacina v
				inner join paciente p on p.codpac = v.codpac
				inner join usuario u on u.cpfusu = p.cpfusu
				inner join endereco en on en.cpfusu = u.cpfusu
				inner join cidade c on c.codcid = en.codcid
				where ((c.codcid = codigo) and (v.dosvac = '1'));
			return conta; 
			end
			$body$
			language plpgsql;@
			
			<!--Funcao segunda-dose-cidade -->
			create or replace function s_dose_cidade(codigo numeric(6,0))
			returns numeric
			as
			$body$
			declare
				conta NUMERIC := 0;
			begin
				select count(*) into conta from vacina v
				inner join paciente p on p.codpac = v.codpac
				inner join usuario u on u.cpfusu = p.cpfusu
				inner join endereco en on en.cpfusu = u.cpfusu
				inner join cidade c on c.codcid = en.codcid
				where ((c.codcid = codigo) and (v.dosvac = '2'));
			return conta; 
			end
			$body$
			language plpgsql;@
			
			<!--Funcao trigger-dose-vacina -->
			create or replace function controla_dosvac()
			returns trigger
			as
			$body$
			begin
				if (new.dosvac &gt; 2) or (new.dosvac &lt; 1) then
					raise exception 'Dose invalida';
				end if;
				return new;		
			end
			$body$
			language plpgsql;@
			
			<!--Trigger-dose-vacina -->
			create trigger vacina_dosvac_before_tg
			before insert or update
			on vacina
			for each row
			execute procedure controla_dosvac();@
			
			<!--Funcao trigger-data-vacina -->
			create or replace function controla_datvac()
			returns trigger
			as
			$body$
			begin
				if (new.datvac &gt; (current_date)) then
					raise exception 'Data invalida';
				end if;
				return new;		
			end
			$body$
			language plpgsql;@
			
			<!--Trigger-data-vacina -->
			create trigger vacina_datvac_before_tg
			before insert
			on vacina
			for each row
			execute procedure controla_datvac();@
			
			<!--Funcao trigger-sitpac-paciente-covpactes-testecovid -->
			create or replace function controla_sitpac()
			returns trigger
			as
			$body$
			begin
				if (new.covpactes = 'P') then
					update paciente set sitpac = 'ISOLAMENTO' where paciente.codpac = new.codpac_codpac;
				end if;
				return new;		
			end
			$body$
			language plpgsql;@
			
			
			<!--Trigger-sitpac-paciente-covpactes-testecovid -->
			create trigger testecovid_after_tg
			after insert or update
			on teste_covid
			for each row
			execute procedure controla_sitpac();@
			
			<!--View conta-medicos -->
			create view vw_conta_medicos as
			select count(*) from medico;@
			
			<!--View conta-empresas -->
			create view vw_conta_empresas as
			select count(*) from empresa;@
			
			<!--View conta-pacientes -->
			create view vw_conta_pacientes as
			select count(*) from paciente;@
			
			<!--View conta-usuarios-->
			create view vw_conta_usuarios as
			select count(*) from usuario;@
			
			<!--Procedure cria usuario-->
			create or replace procedure create_user(email varchar(30), senha varchar(20))
			as
			$body$
			begin
				execute format('create user %I with password ''%s''', email, senha);
			end
			$body$
			language plpgsql;@
			
			<!--Grupo empresa-->
			create group g_empresa;@
			<!--Grupo paciente-->
			create group g_paciente;@
			<!--Grupo medico-->
			create group g_medico;@
			<!--Grupo administrador-->
			create group g_administrador;@
			<!--Grupo usuario-->
			create group g_usuario;@
			
			<!--Grant usuarios-->
			grant select, insert, update, delete
			on usuario, endereco
			to g_usuario;@
			
			grant select
			on pais, estado, cidade, comorbidade
			to g_usuario;
			
			grant insert
			on solicitacao, paciente, paciente_comorbidade, medico, empresa
			to g_usuario;@
			
			<!--Grant empresas-->
			grant select, insert, update, delete
			on empresa
			to g_empresa;@
			
			grant select
			on paciente, vacina, teste_covid
			to g_empresa;@
			
			<!--Grant pacientes-->
			grant select, insert, update
			on teste_covid, monitoramento_paciente, vacina
			to g_paciente;@
			
			grant delete
			on paciente, paciente_comorbidade
			to g_paciente;@
			
			<!--Grant administrador-->
			grant select, insert, update, delete
			on all tables in schema public
			to g_administrador;@
			
			<!--Procedure grant empresa-->
			create or replace procedure grant_empresa(email varchar(30))
			as
			$body$
			begin
				execute format('grant g_empresa to %I', email);
			end
			$body$
			language plpgsql;@
			
			<!--Procedure grant paciente-->
			create or replace procedure grant_paciente(email varchar(30))
			as
			$body$
			begin
				execute format('grant g_paciente to %I', email);
			end
			$body$
			language plpgsql;@
			
			<!--Procedure grant medico-->
			create or replace procedure grant_medico(email varchar(30))
			as
			$body$
			begin
				execute format('grant g_medico to %I', email);
			end
			$body$
			language plpgsql;@
			
			<!--Procedure grant administrador-->
			create or replace procedure grant_administrador(email varchar(30))
			as
			$body$
			begin
				execute format('grant g_administrador to %I', email);
			end
			$body$
			language plpgsql;@
			
			<!--Procedure grant usuario-->
			create or replace procedure grant_usuario(email varchar(30))
			as
			$body$
			begin
				execute format('grant g_usuario to %I', email);
			end
			$body$
			language plpgsql;@
			
			<!--Procedure drop usuario-->
			create or replace procedure drop_user(email varchar(30))
			as
			$body$
			begin
				execute format('drop role %I', email);
			end
			$body$
			language plpgsql;@
			
			<!--Procedure troca senha-->
			create or replace procedure alter_password(email varchar(30), senha varchar(30))
			as
			$body$
			begin
				execute format('alter role %I with password ''%s''', email, senha);
			end
			$body$
			language plpgsql;@
			
			<!--Procedure troca email-->
			create or replace procedure alter_email(email varchar(30), newemail varchar(30))
			as
			$body$
			begin
				execute format('alter role %I rename to %L', email, newemail);
			end
			$body$
			language plpgsql;@
			
			<!--Procedure revoke group-->
			create or replace procedure revoke_group(email varchar(30), grupo varchar(20))
			as
			$body$
			begin
				execute format('revoke %I FROM %L', email, grupo);
			end
			$body$
			language plpgsql;@
			
			
			<!--VIEWS ANTIGAS-->

			<!--1) Relacione o código e nome de
			pacientes com idades entre 40 e 50
			anos, que apresentaram tosse.
			Relacione a consulta em ordem
			descendente de código; OK
			2) Relacione o nome do paciente,
			nome da cidade de residência de
			pacientes do sexo masculino,
			residentes nos municípios de
			Maravilha, Descanso, Pinhalzinho,
			Chapecó e Itapiranga que
			apresentaram sintomas e não foram
			positivados com covid. Relacione o
			relatório pelo nome da cidade
			descendente e o nome do paciente
			ascendente;  OK
			3) Relacione o código da cidade,
			nome da cidade, quantidade de casos
			suspeitos de covid para todas as
			cidades. Ordene o relatório da cidade
			com menos casos suspeitos para a
			cidade com mais casos suspeitos; OK
			4) Relacione a idade do paciente e
			quantidade de casos positivos de
			covid por idade, registrados em dias
			pares de 2020. Ordene o relatório pela
			idade com mais casos para a idade
			com menos casos.-->
			
			
			create view vw_select1 as 
			select p.codpac, u.nomusu from paciente p 
			inner join usuario u on u.cpfusu = p.cpfusu_cpfusu 
			inner join monitoramento_paciente mp on mp.codpac_codpac = p.codpac 
			inner join sintoma s on mp.codsin_codsin = s.codsin 
			where s.nomsin ilike '%tosse%' and 
			(extract(year from current_timestamp) - extract(year from u.datnasusu)&gt;=40) and 
			(extract(year from current_timestamp) - extract(year from u.datnasusu)&lt;=50)
			order by p.codpac desc;
			
			
			create view vw_select2 as
			select u.nomusu, c.nomcid from paciente p 
			inner join usuario u on u.cpfusu = p.cpfusu_cpfusu 
			inner join endereco e on e.cpfusu_cpfusu = u.cpfusu
			inner join cidade c on c.codcid = e.codcid_codcid 
			inner join teste_covid tc on tc.codpac_codpac = p.codpac 
			inner join monitoramento_paciente mp on mp.codpac_codpac = p.codpac 
			where (tc.covpactes = 'N') and (mp.codsin_codsin not null) and (u.sexusu = 'M') and (c.nomcid in('Maravilha', 'Descanso', 'Pinhalzinho', 'Chapecó', 'Itapiranga'))
			order by c.nomcid desc, u.nomusu;
			
			
			create view vw_select3 as 
			select c.codcid, c.nomcid, count(distinct(mp.codpac_codpac)) as conta from cidade c 
			left join endereco e on e.codcid_codcid = c.codcid 
			left join usuario u on u.cpfusu = e.cpfusu_cpfusu 
			left join paciente p on p.cpfusu_cpfusu = u.cpfusu 
			left join monitoramento_paciente mp on mp.codpac_codpac = p.codpac 
			group by c.codcid
			order by conta;
			
			
			create view vw_select4 as
			select to_char(age(u.datnasusu),'YY') as idade, count(*) as casos from paciente p
			inner join teste_covid tc on tc.codpac_codpac = p.codpac 
			inner join usuario u on u.cpfusu = p.cpfusu_cpfusu 
			where tc.covpactes ='P' and ((extract(DAY from tc.dattes)::Integer)%2)=0
			group by idade
			order by casos desc;
		
		</sql>
	</changeSet>

	<changeSet id="tag-1.1" author="Eduardo Mateus da Costa">
		<tagDatabase tag="1.1" />
	</changeSet>

</databaseChangeLog>

